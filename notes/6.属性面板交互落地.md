# 属性面板交互落地

> **提交**: `13e1ddbd` | **时间**: 2025-11-08 17:07:33 | **作者**: juanlou1217

【本次实现内容】  
1. 功能：在顶部工具栏新增“填充色、描边色、描边粗细、不透明度”四项属性编辑，支持画布对象实时预览。  
2. 技术栈：Next.js 15 + React 19 + Fabric.js（Canvas 渲染）+ Radix UI（滑块/标签/颜色选择）+ react-color（取色器）。  
3. 关键概念：  
   • 受控组件：Slider/ColorPicker 的值与 Fabric 对象属性双向绑定。  
   • 局部状态与画布状态同步：通过 useEditor 提供的 selectedObjects 快照，避免整树重渲染。  
   • 微交互：拖动滑块时 16 ms 节流 + Fabric 的 set/restore 批量渲染，保证 60 FPS。

【技术选型与设计思路】  
1. 为什么 Radix Slider／react-color：  
   • 无障碍、暗色模式、键盘操作开箱即用，减少自研成本。  
   • react-color 提供 Sketch 面板，与设计同学熟悉的 Figma 体验对齐。  
2. 为什么拆成 4 个 Sidebar 组件：  
   • 每个属性面板内部状态隔离，未来可插拔到右侧“属性栏”或“浮动弹出层”，不耦合 TopToolbar。  
3. 架构亮点：  
   • 统一 useCanvasEvents 收口 Fabric 的 selection:created/updated/cleared，把“选中态”转成可序列化的 plain object，供 React 层消费，避免把 Fabric 实例直接注入组件，保持单向数据流。  
   • 属性变更走“命令”通道：toolbar -> useEditor.setProperty -> canvas.getActiveObjects().forEach(obj => obj.set(key, val)) -> canvas.requestRenderAll()，为后续“撤销/重做”埋点（命令模式）。

【实现细节】  
1. 滑块精度：  
   • 不透明度 0-1 步长 0.01，描边宽度 0-50 步长 1，用 Radix Slider 的 step 即可；但 Fabric 内部描边宽度为 Number，需 Math.max(0, val) 防止负值。  
2. 颜色格式：  
   • react-color 返回 { hex, rgb, hsl }，Fabric 接受 hex 或 rgba 字符串；当不透明度<1 时拼成 rgba(${r},${g},${b},${a})，避免 hex8 不被旧版 Fabric 识别。  
3. 性能：  
   • 拖动滑块高频触发，使用 useRef 存上一次有效值，仅当偏差>0.5% 才提交，减少 Fabric 重绘；  
   • 面板隐藏时（sidebar 折叠）卸载 react-color，减少 200 KB 色板脚本常驻内存。  
4. 难点：  
   • Fabric 组选时（activeSelection）set 属性需遍历 _objects，但 activeSelection 本身无 fill/stroke；封装 setObjectAttr(obj, key, val) 统一处理单体与组选，代码更简洁。

【开发收获】  
1. 把“画布状态”与“React 状态”做严格分层：Canvas 是单一事实来源，React 仅做“镜像 + 控制命令”，可显著降低不一致 Bug。  
2. Radix 组件 API 粒度非常细，可组合出高度还原设计的交互；但需留意版本差异（如 Slider 1.3.6 开始用 number 而非 string 返回值）。  
3. 下一步：  
   • 把属性变更封装为 Command，接入命令栈，实现 Ctrl+Z/Y；  
   • 颜色变量注入 CSS Variables，支持主题一键切换；  
   • 属性面板响应式布局，移动端折叠到侧边抽屉。

---

**变更文件**: package-lock.json, package.json, src/app/globals.css, src/components/ui/label.tsx, src/components/ui/slider.tsx, src/features/editor/components/editor.tsx, src/features/editor/components/toolbar.tsx, src/features/editor/components/topToolbar/color-picker.tsx, src/features/editor/components/topToolbar/fill-color-sidebar.tsx, src/features/editor/components/topToolbar/opacity-sidebar.tsx, src/features/editor/components/topToolbar/strokel-color-sidebar.tsx, src/features/editor/components/topToolbar/strokel-width-sidebar.tsx, src/features/editor/hooks/use-canvas-events.ts, src/features/editor/hooks/use-editor.ts, src/features/editor/types.ts, src/features/editor/utils.ts