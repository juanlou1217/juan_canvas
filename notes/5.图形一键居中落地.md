# 图形一键居中落地

> **提交**: `8330a14b` | **时间**: 2025-11-07 18:31:21 | **作者**: juanlou1217

【开发笔记】

一、本次实现内容  
1. 功能  
   • 在左侧「形状」面板中点击图标，即可把圆形、矩形、圆角矩形、正/倒三角、菱形 6 种基础图形插入画布。  
   • 插入后图形自动居中在工作区（workspace）中心，并被立即激活（setActiveObject），用户可直接拖拽或修改。  

2. 技术栈  
   • Next.js 14 App Router（React 18）  
   • shadcn/ui + Radix ScrollArea：新增可复用滚动容器组件，保证侧边栏在内容溢出时表现一致。  
   • Fabric.js 5.x：负责 Canvas 渲染、对象管理、居中计算。  
   • TypeScript：强类型定义 Editor 能力，便于后续扩展。  

3. 关键概念  
   • Editor 抽象层：把「画布能力」封装成纯函数集合，业务组件只依赖 Editor 类型，不直接调用 Fabric API，方便以后替换 Konva 或 Pixi。  
   • workspace（clip）对象：画布中一个特殊命名的对象，作为「可视工作区」边界，所有「居中」逻辑都基于它，而非整个画布宽高，保证导出/打印时与预览一致。  
   • 命令式封装：addCircle() … addDiamond() 等函数内部完成「创建 → 居中 → 加入 → 激活」四步，调用方零成本。

二、技术选型与设计思路  
1. 为什么再包一层 Editor  
   • 历史经验：直接在各组件里写 `new fabric.Circle(...)` 会导致：  
     – 魔法数分散（颜色、默认尺寸、描边等）  
     – 单测难以 mock Canvas  
   • 解决方案：参考「Repository Pattern」+「Command Pattern」，将“对画布的操作”收敛到 buildEditor() 返回的对象里；上层仅依赖接口 Editor，后续可无痛切换渲染引擎。  

2. 为什么用 Radix ScrollArea  
   • 浏览器默认滚动条在 Windows 下很宽，会挤压 48px 固定宽度的侧边栏，造成图标换行。  
   • Radix 提供「区域滚动 + 自定义拇指」能力，样式与 macOS 一致，且支持 `data-slot` 便于在 tailwind 中覆盖。  

3. 居中选择 `canvas._centerObject(obj, center)`  
   • Fabric 暴露的 `centerObject` 是以画布宽高为基准；而我们需要的是「工作区中心」。  
   • 源码发现 `_centerObject(obj, centerPoint)` 是内部方法，正好满足需求；先临时 ts-ignore，后续提 PR 给 Fabric 增加公有 API。  

三、实现细节与难点  
1. 工作区定位  
   ```ts
   const getWorkspace = () =>
     canvas.getObjects().find((o) => o.name === 'clip') as fabric.Object;
   ```
   要求初始化 canvas 时必须把 clip 对象 name 设为 'clip'，否则居中失效 → 在 init() 里加断言，防止静默失败。  

2. 菱形构造  
   Fabric 没有 Diamond 基元，使用 `new fabric.Polygon([...], { ...DIAMOND_OPTIONS })`。  
   顶点坐标按「宽一半、高一半」对称写死，保证与统一尺寸常量复用。  

3. 圆角矩形  
   在 RECTANGLE_OPTIONS 基础上加 `rx:50, ry:50`；为了与「直角矩形」图标区分，SidebarTool 的 iconClassName 保持不变，靠 tooltip 文字提示。  

4. 性能点  
   • 每个 addXxx() 里只触发一次 `canvas.add()` + `canvas.setActiveObject()`，避免多次渲染。  
   • 使用 `useMemo(() => buildEditor({ canvas }), [canvas])` 保证 Editor 实例只创建一次，减少闭包开销。  

5. 类型安全  
   在 types.ts 中把  
   ```ts
   type Editor = {
     addCircle: () => void;
     ...
   }
   ```
   写全，以后加「箭头、星形、连线」时，IDE 会强制同步 Sidebar 与 Editor 实现，防止「图标有点击而方法未实现」的尴尬。  

四、开发收获与后续方向  
1. 收获  
   • 学会 Fabric 内部 `_centerObject` 的“私货”用法，理解「对象中心点 vs 画布中心点」差异。  
   • 抽象 Editor 能力层后，组件 stories 可以传一个「假 Editor」做到纯 UI 快照测试，TDD 更顺。  

2. 下一步  
   • 把「默认样式」抽到 Theme 层，支持深色模式。  
   • 支持键盘快捷键（R 矩形、C 圆形），需把 activeTool 放进全局 Store。  
   • 实现 Undo/Redo：在 addXxx() 里同时 push 命令到 CommandManager，Fabric 的 JSON 快照太大，考虑用 fabric-history 或自研 delta。  
   • 图形多选 + 对齐分布： workspace 中心计算逻辑可复用，对齐上下左右只需改 center 函数。  

3. 可能坑  
   • Fabric 6 将废除 `canvas._centerObject`，届时需自己算 centerPoint：  
     ```ts
     const center = workspace.getCenterPoint();
     obj.setPositionByOrigin(center, 'center', 'center');
     ```  
     已留注释备忘。

---

**变更文件**: src/components/ui/scroll-area.tsx, src/features/editor/components/editor.tsx, src/features/editor/components/toolSidebar/shape-sideber.tsx, src/features/editor/hooks/use-editor.ts, src/features/editor/types.ts