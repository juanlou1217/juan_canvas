# 自动化提交笔记流水线

> **提交**: `368215e5` | **时间**: 2025-10-21 14:55:31 | **作者**: juanlou1217

[详细内容]

## 🎯 本次实现内容  
1. GitHub Actions 工作流「Commit Summary」  
   - 监听 master 分支 push，自动抓取本次提交的 hash、message、作者、时间、变更文件列表及 diff  
   - 调用 Moonshot（kimi）大模型，按固定提示词生成中文开发笔记，包含标题、实现内容、技术选型、实现细节、开发收获等 5 大板块  
   - 将生成结果写入 `notes/序号.标题.md`，并自动 commit & push 回仓库，实现“代码一推送，笔记即归档”  

2. 技术栈与工具  
   - CI/CD：GitHub Actions（ubuntu-latest）  
   - 运行时：Node 18  
   - 依赖：openai（兼容 Moonshot 接口）、dayjs  
   - 提示词工程：结构化模板 + 温度 0.7 + 4k token 上限，保证输出稳定且不过度发散  

3. 关键概念  
   - 大模型驱动的自动生成（LLM4DevOps）  
   - 提交元数据提取（git rev-parse / diff-tree / show）  
   - 文件系统安全写（递归 mkdir、非法字符清洗、序号自增）  
   - 机器人身份提交（GITHUB_TOKEN + x-access-token 方式）  

## 💡 技术选型与设计思路  
1. 为什么用 GitHub Actions  
   - 零运维：无需额外服务器，与代码仓库天然集成  
   - 事件驱动：push 即触发，实时性高  
   - 权限模型清晰：GITHUB_TOKEN 只授予 contents:write，风险可控  

2. 为什么选择 Moonshot 而非 OpenAI 官方  
   - 国内网络友好，延迟低  
   - 价格仅为 GPT-4 的 1/10，适合高频提交场景  
   - 兼容 OpenAI SDK，零成本迁移  

3. 架构亮点  
   - “单文件脚本”策略：在 CI 里动态写出 analyze-commit.js，避免把临时脚本污染主仓库  
   - 幂等设计：同一次提交重复运行不会重复追加笔记，利用 git diff --staged --quiet 判断  
   - 提示词分层：先让模型输出“标题:”行，再正则提取，兼顾格式与内容自由度  

## 🔧 实现细节  
1. 核心流程  
   push → checkout（fetch-depth=0 保证能 diff）→ npm install → 生成脚本 → node 执行 → 提交笔记 → [skip ci] 防止递归触发  

2. 技术难点与对策  
   - diff 过长：截断 8000 字符，既控制 token 消耗，又保留关键上下文  
   - 文件名非法字符：正则替换 [<>:“/\\|?*] 为 -，并限制 50 字符，保证跨平台兼容  
   - 并发冲突：多提交同时 push 可能失败，利用 git pull --rebase 再 push 可进一步增强健壮性（当前依赖 GitHub 的自动重试）  

3. 性能与最佳实践  
   - paths-ignore: notes/ 避免笔记目录变更再次触发工作流  
   - 缓存 node_modules 可再提速（本次未加，后续可优化）  
   - 模型温度 0.7 在“稳定”与“创意”间折中，实测中文技术笔记可读性最佳  

## 📚 开发收获  
1. 新知  
   - GitHub Actions 的 id-token 与 permissions 细粒度授权机制  
   - Moonshot API 与 OpenAI SDK 的“无缝切换”技巧（baseURL 替换即可）  
   - 用 git show --format="" 获取纯 diff，避免日志信息干扰 token  

2. 对项目架构的理解  
   - 把“文档”纳入 CI 流水线，形成“代码-文档”双轨迭代，可显著提升后期复盘与交接效率  
   - 笔记按序号+标题独立文件，方便后续生成静态网站或 PDF 归档  

3. 后续改进方向  
   - 支持 PR 阶段生成“预览笔记”，合并后才落库，避免实验性分支污染笔记目录  
   - 增加缓存与增量更新，只分析新增 commit，而非每次全量拉取历史  
   - 提供本地 CLI 版本（如 npx juan-canvas-note），让开发者离线也能生成同格式笔记  
   - 接入图床，自动将 diff 里的 svg/base64 转成外链，减少仓库体积

---

**变更文件**: .github/workflows/commit-summary.yml, .idea/.gitignore, .idea/inspectionProfiles/Project_Default.xml, .idea/juan_canvas.iml, .idea/modules.xml, .idea/vcs.xml, components.json, package-lock.json, package.json, src/app/globals.css, src/app/page.tsx, src/components/ui/button.tsx, src/lib/utils.ts