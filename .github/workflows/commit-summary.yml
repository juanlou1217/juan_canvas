name: Commit Summary

on:
  push:
    branches: [master]
    paths-ignore:
      - 'notes/'

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install openai dayjs

      - name: Create AI commit analysis script
        run: |
          cat > analyze-commit.js << 'EOF'
          import fs from 'fs';
          import path from 'path';
          import { execSync } from 'child_process';
          import dayjs from 'dayjs';
          import OpenAI from 'openai';

          const openai = new OpenAI({
            baseURL: 'https://api.moonshot.cn/v1',
            apiKey: process.env.MOONSHOT_API_KEY
          });

          async function analyzeCommit() {
            try {
              // è·å–æœ€æ–°æäº¤çš„ä¿¡æ¯
              const commitHash = execSync('git rev-parse HEAD', { encoding: 'utf-8' }).trim();
              const commitMsg = execSync('git log -1 --pretty=%s', { encoding: 'utf-8' }).trim();
              const commitAuthor = execSync('git log -1 --pretty=%an', { encoding: 'utf-8' }).trim();
              const commitDate = dayjs().format('YYYY-MM-DD HH:mm:ss');
              
              // è·å–æäº¤çš„æ–‡ä»¶å˜æ›´
              const changedFiles = execSync('git diff-tree --no-commit-id --name-only -r HEAD', { encoding: 'utf-8' })
                .trim().split('\n').filter(f => f);
              
              // è·å–æäº¤çš„å·®å¼‚ï¼ˆé™åˆ¶é•¿åº¦ï¼‰
              const diff = execSync('git show HEAD --format="" --no-color', { encoding: 'utf-8' }).substring(0, 8000);
              
              // ç¡®ä¿ notes ç›®å½•å­˜åœ¨
              const notesDir = 'notes';
              if (!fs.existsSync(notesDir)) {
                fs.mkdirSync(notesDir, { recursive: true });
              }

              // è·å–ç°æœ‰ç¬”è®°æ–‡ä»¶ï¼Œç¡®å®šä¸‹ä¸€ä¸ªåºå·
              const existingFiles = fs.readdirSync(notesDir)
                .filter(f => f.match(/^\d+\./))
                .map(f => parseInt(f.split('.')[0]))
                .filter(n => !isNaN(n));
              
              const nextNumber = existingFiles.length > 0 ? Math.max(...existingFiles) + 1 : 1;
              
              // æ„å»º AI åˆ†ææç¤º
              const prompt = `
          æˆ‘æ­£åœ¨å¼€å‘ä¸€ä¸ªåœ¨çº¿å›¾å½¢ç»˜åˆ¶å¹³å°ï¼ˆç±»ä¼¼åŸå‹è®¾è®¡å·¥å…·ï¼‰ï¼Œå¹¶ç»“åˆ AI å›¾åƒå¤„ç†åŠŸèƒ½ã€‚è¯·åˆ†æè¿™æ¬¡æäº¤ï¼Œç”Ÿæˆå¼€å‘ç¬”è®°ï¼š

          ## ğŸ“ æäº¤ä¿¡æ¯
          **æäº¤**: ${commitHash.substring(0, 8)}
          **æ¶ˆæ¯**: ${commitMsg}
          **ä½œè€…**: ${commitAuthor}
          **æ—¶é—´**: ${commitDate}
          **å˜æ›´æ–‡ä»¶**: ${changedFiles.join(', ')}

          ## ğŸ’» ä»£ç å˜æ›´
          \`\`\`diff
          ${diff}
          \`\`\`

          è¯·å¸®æˆ‘åˆ†æè¿™æ¬¡æäº¤ï¼Œé‡ç‚¹å…³æ³¨ï¼š

          ## ğŸ¯ æœ¬æ¬¡å®ç°å†…å®¹
          - å…·ä½“å®ç°äº†ä»€ä¹ˆåŠŸèƒ½æˆ–ç‰¹æ€§
          - ä½¿ç”¨äº†å“ªäº›æŠ€æœ¯æ ˆå’Œå·¥å…·ï¼ˆå¦‚ Next.jsã€shadcn/uiã€Canvas API ç­‰ï¼‰
          - æ¶‰åŠäº†å“ªäº›å…³é”®æ¦‚å¿µ

          ## ğŸ’¡ æŠ€æœ¯é€‰å‹ä¸è®¾è®¡æ€è·¯
          - ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§å®ç°æ–¹å¼
          - æŠ€æœ¯é€‰å‹çš„è€ƒè™‘å› ç´ 
          - æ¶æ„è®¾è®¡çš„äº®ç‚¹

          ## ğŸ”§ å®ç°ç»†èŠ‚
          - æ ¸å¿ƒä»£ç å®ç°é€»è¾‘
          - é‡åˆ°çš„æŠ€æœ¯éš¾ç‚¹åŠè§£å†³æ–¹æ¡ˆ
          - æ€§èƒ½ä¼˜åŒ–æˆ–æœ€ä½³å®è·µ

          ## ğŸ“š å¼€å‘æ”¶è·
          - å­¦åˆ°äº†ä»€ä¹ˆæ–°çŸ¥è¯†
          - å¯¹é¡¹ç›®æ•´ä½“æ¶æ„çš„ç†è§£
          - åç»­å¯ä»¥æ”¹è¿›çš„æ–¹å‘

          è¯·åŸºäºæäº¤ä¿¡æ¯ç»™å‡ºä¸€ä¸ªç®€çŸ­çš„æ ‡é¢˜ï¼ˆä¸è¶…è¿‡15ä¸ªå­—ï¼Œä¸è¦åŒ…å«åºå·ï¼‰ï¼Œä»¥åŠè¯¦ç»†çš„å¼€å‘ç¬”è®°ã€‚
          è¿”å›æ ¼å¼ï¼š
          æ ‡é¢˜: [ä½ çš„æ ‡é¢˜]
          
          [è¯¦ç»†å†…å®¹]
          
          è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œå†…å®¹è¦å®ç”¨ä¸”æœ‰æ·±åº¦ã€‚
          `;

              // è°ƒç”¨ AI ç”Ÿæˆåˆ†æ
              const response = await openai.chat.completions.create({
                model: 'kimi-k2-0905-preview',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 4000
              });

              const analysisText = response.choices[0].message.content.trim();
              
              // æå–æ ‡é¢˜å’Œå†…å®¹
              let title = commitMsg;
              let content = analysisText;
              
              const titleMatch = analysisText.match(/æ ‡é¢˜[:ï¼š]\s*(.+?)[\n\r]/);
              if (titleMatch) {
                title = titleMatch[1].trim();
                content = analysisText.replace(/æ ‡é¢˜[:ï¼š]\s*.+?[\n\r]+/, '').trim();
              }
              
              // æ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
              title = title.replace(/[<>:"/\\|?*]/g, '-').substring(0, 50);
              
              // åˆ›å»ºæ ¼å¼åŒ–çš„ç¬”è®°
              const noteContent = [
                `# ${title}`,
                '',
                `> **æäº¤**: \`${commitHash.substring(0, 8)}\` | **æ—¶é—´**: ${commitDate} | **ä½œè€…**: ${commitAuthor}`,
                '',
                content,
                '',
                '---',
                '',
                `**å˜æ›´æ–‡ä»¶**: ${changedFiles.join(', ')}`
              ].join('\n')

              // ä¿å­˜ä¸ºç‹¬ç«‹æ–‡ä»¶
              const fileName = `${nextNumber}.${title}.md`;
              const filePath = path.join(notesDir, fileName);
              fs.writeFileSync(filePath, noteContent, 'utf-8');
              
              console.log(`âœ… ç¬”è®°å·²ç”Ÿæˆ: ${fileName}`);
              
            } catch (error) {
              console.error('âŒ Error analyzing commit:', error.message);
              process.exit(1);
            }
          }

          analyzeCommit();
          EOF

      - name: Run commit analysis
        env:
          MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
        run: |
          node analyze-commit.js

      - name: Commit and Push Summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if [[ -d "notes" ]]; then
            git add notes/
            
            if ! git diff --staged --quiet; then
              COMMIT_HASH=$(git rev-parse HEAD | cut -c1-8)
              COMMIT_MSG=$(git log -1 --pretty=%s)
              git commit -m "ğŸ“ å¼€å‘ç¬”è®°: ${COMMIT_MSG} (${COMMIT_HASH}) [skip ci]"
              
              # ä½¿ç”¨ GITHUB_TOKEN æ¨é€
              git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
              git push
              echo "âœ… å¼€å‘ç¬”è®°å·²æ›´æ–°å¹¶æ¨é€"
            else
              echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
            fi
          else
            echo "âŒ notes ç›®å½•æœªæ‰¾åˆ°"
          fi